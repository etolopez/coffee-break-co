// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION & RBAC
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  region    String
  hmacKey   String?  // per-tenant HMAC shared secret (MVP)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users       ActorUser[]
  products    Product[]
  facilities  Facility[]
  lots        Lot[]
  batches     Batch[]
  certificates Certificate[]
  events      EpcisEventRecord[]
  idempotency IdempotencyRecord[]

  @@map("organizations")
}

model ActorUser {
  id   String @id @default(cuid())
  email String @unique
  role  String
  orgId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("actor_users")
}

// ============================================================================
// PRODUCT, FACILITY, LOT, BATCH
// ============================================================================

model Product {
  id      String @id @default(cuid())
  orgId   String
  gtin    String
  name    String
  brand   String
  images  Json   // Array of image URLs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, gtin])
  @@index([gtin])
  @@map("products")
}

model Facility {
  id      String   @id @default(cuid())
  orgId   String
  gln     String?  // Global Location Number
  name    String
  address String?
  lat     Float?   // Latitude
  lon     Float?   // Longitude
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, gln])
  @@map("facilities")
}

model Lot {
  id        String   @id @default(cuid())
  orgId     String
  code      String
  metadata  Json     // Lot metadata (harvestYear, origin, varietals, process, altitudeMasl)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, code])
  @@index([code])
  @@map("lots")
}

model Batch {
  id        String   @id @default(cuid())
  orgId     String
  code      String
  metadata  Json     // Batch metadata (roastDate, profile, machine, netOutputKg)
  inputLotCodes String[] // denormalized helper for lot linking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, code])
  @@index([code])
  @@map("batches")
}

// ============================================================================
// CERTIFICATES
// ============================================================================

model Certificate {
  id        String    @id @default(cuid())
  orgId     String
  type      String    // Certificate type (e.g., "Organic", "Fair Trade")
  issuer    String    // Issuing organization
  validFrom DateTime?
  validTo   DateTime?
  url       String?   // External URL to certificate
  vcJwt     String?   // W3C Verifiable Credential JWT
  fileKey   String?   // S3 object key for stored file
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("certificates")
}

// ============================================================================
// EPCIS EVENTS
// ============================================================================

model EpcisEventRecord {
  id        String   @id @default(cuid())
  orgId     String
  eventType String   // EPCIS event type
  eventTime DateTime
  readPoint String?  // SGLN URN
  bizLocation String? // SGLN URN
  hash      String   @unique // content address hash
  signature String?  // HMAC/Detached JWS
  doc       Json     // raw EPCIS JSON-LD
  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([eventTime])
  @@map("epcis_events")
}

// ============================================================================
// IDEMPOTENCY
// ============================================================================

model IdempotencyRecord {
  id        String   @id @default(cuid())
  orgId     String
  key       String   // Idempotency key from header
  response  Json     // Cached response
  expiresAt DateTime // TTL for cleanup
  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, key])
  @@index([expiresAt]) // For cleanup jobs
  @@map("idempotency_records")
}

// ============================================================================
// SCAN TELEMETRY (for analytics)
// ============================================================================

model ScanEvent {
  id        String   @id @default(cuid())
  gtin      String
  lot       String?
  serial    String?
  country   String?
  city      String?
  userAgent String?
  resolverLatencyMs Int?
  scannedAt DateTime @default(now())

  @@index([gtin])
  @@index([scannedAt])
  @@map("scan_events")
}

// ============================================================================
// USER AUTHENTICATION & PROFILES
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password
  name      String?
  role      String   @default("customer") // customer, seller, admin
  avatar    String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile   UserProfile?
  favorites UserFavorite[]
  sellers   Seller[]  // If user is a seller, link to Seller records

  @@map("users")
  @@index([email])
  @@index([role])
}

model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  bio       String?
  location  String?
  website   String?
  preferences Json?  // User preferences (theme, notifications, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  coffeeId  String
  createdAt DateTime @default(now())

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  coffee Coffee @relation(fields: [coffeeId], references: [id], onDelete: Cascade)

  @@unique([userId, coffeeId])
  @@index([userId])
  @@index([coffeeId])
  @@map("user_favorites")
}

// ============================================================================
// COFFEE DIGITAL PASSPORT MODELS
// ============================================================================

model Seller {
  id                String   @id @default(cuid())
  companyName       String
  companySize       String?
  mission           String?
  logo              String?
  phone             String?
  email             String?
  location          String?
  country           String?
  city              String?
  rating            Float     @default(0)
  totalCoffees       Int       @default(0)
  memberSince       Int
  specialties       String[]  @default([])
  featuredCoffeeId  String?
  description       String?
  website           String?
  instagram         String?
  facebook          String?
  twitter           String?
  certifications    String[]  @default([])
  uniqueSlug        String    @unique
  defaultPricePerBag String?
  orderLink         String?
  coffeesUploaded   Int       @default(0) // Track number of coffees uploaded for payment
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  coffees           Coffee[]
  userId            String?  // Foreign key to User
  user              User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("sellers")
  @@index([uniqueSlug])
  @@index([userId])
}

model Coffee {
  id                    String   @id @default(cuid())
  coffeeName            String
  roastedBy             String?
  sellerId              String?
  origin                String
  region                String?
  altitude              String?
  process               String?
  variety               String?
  harvestYear           String?
  roastLevel            String?
  flavorNotes           String[]  @default([])
  description           String?
  price                 String?
  currency              String?   @default("USD")
  weight                String?
  qrCode                String?
  slug                  String?   @unique
  farmPhotos            String[]  @default([])
  roastingCurveImage    String?
  coordinatesLat        Float?
  coordinatesLng         Float?
  certifications        String[]  @default([])
  environmentalPractices String[] @default([])
  farm                  String?
  farmer                String?
  cuppingScore          String?
  notes                 String?
  harvestDate           String?
  processingDate        String?
  producerName          String?
  producerBio           String?
  aroma                 String?
  flavor                String?
  acidity               String?
  body                  String?
  primaryNotes          String?
  secondaryNotes        String?
  finish                String?
  fermentationTime      String?
  dryingTime            String?
  moistureContent       String?
  screenSize            String?
  beanDensity           String?
  roastRecommendation   String?
  fairTradePremium      String?
  communityProjects     String?
  womenWorkerPercentage String?
  available             Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  seller                Seller?   @relation(fields: [sellerId], references: [id], onDelete: SetNull)
  favorites             UserFavorite[]

  @@map("coffees")
  @@index([sellerId])
  @@index([slug])
  @@index([origin])
}
